Найденные проблемы качества (code smells):

Длинная функция process_checkout.

Дублирование/шум: много проверок и вычислений вперемешку со “сценарием”.

Магические числа (0.21, 0.10, 200, 50 и т.п.) зашиты в код.

Плохая читаемость: сложно понять порядок шагов оформления заказа.

Применённые рефакторинги:

Extract Function: выделены функции validate_request, validate_items, calculate_subtotal, calculate_discount, calculate_tax, generate_order_id, build_response.

Introduce Constants: вынесены ставки налога/скидок, пороги и фиксированные значения в константы.

“Чтение сверху вниз”: process_checkout теперь выглядит как сценарий (парсинг → валидация → расчёты → сбор ответа).

Поведение сохранено: тексты ошибок, строгая проверка type(items) is list, округления через int().

Что стало проще читать/менять:

Добавлять новые купоны — достаточно расширить calculate_discount.

Менять налоговую ставку/пороги скидок — правка только констант.

Валидацию и расчёты теперь можно тестировать отдельно, не трогая общий поток.